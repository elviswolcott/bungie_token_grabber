<!Doctype HTML>

<head>
  <script src="https://vuejs.org/js/vue.js"> </script>
</head>  

<body>
  <div id="app">
    <button @click="getManifest">load manifest</button>
    <p>code</p>
    <textarea readonly style="width: 100%;">{{code}}</textarea>
    <div v-if="stage == 0">
      <p>Loading tokens...</p>
    </div>
    <div v-if="stage >= 1">
      <p>Token response</p>
      <textarea readonly style="width: 100%; min-height: 200px;">{{response}}</textarea>
      <button @click="refresh">refresh</button>
      <p>refresh_token</p>
      <textarea readonly style="width: 100%;">{{response.refresh_token}}</textarea>
      <p>access_token</p>
      <textarea readonly style="width: 100%;">{{response.access_token}}</textarea>
      <button @click="getMembershipData">show membership data</button>
    </div>
    <div v-if="stage >= 2">
      <p>User.UserMembershipData</p>
      <textarea readonly style="width: 100%; min-height: 200px;">{{user}}</textarea>
      <div v-for="(destinyMembership, index) in user.destinyMemberships" :key="destinyMembership.membershipId">
        <p>Destiny Account: {{destinyMembership.displayName}} ({{ accountTypeToPlaintext(destinyMembership.membershipType )}})</p>
        <textarea readonly style="width: 100%; min-height: 200px;">{{destinyMembership}}</textarea>
        <p>Destiny2.GetProfile for {{destinyMembership.displayName}} ({{ accountTypeToPlaintext(destinyMembership.membershipType )}})</p>
        <p style="display: none" v-if="!profiles[destinyMembership.membershipType].profileInventory">{{getProfile(destinyMembership.membershipType, destinyMembership.membershipId)}}</p>
        <textarea readonly style="width: 100%; min-height: 200px;" v-if="profiles[destinyMembership.membershipType]">{{profiles[destinyMembership.membershipType]}}</textarea>
      </div>
    </div>
    <div v-if="manifest">
      <p>Manifest</p>
      <textarea readonly style="width: 100%;">{{manifest}}</textarea>
    </div>
  </div>
</body>

<script>
  var vm = new Vue({
    el: '#app',
    computed: {
      code: function() {
        return window.location.search.split('=')[1].split('&')[0]
      },
    },
    methods: {
      load: function() {
        fetch("https://www.bungie.net/platform/app/oauth/token/", {
          body: "grant_type=authorization_code&code=" + this.code + "&client_secret=" + localStorage.getItem('secret') + "&client_id=" + localStorage.getItem('id'),
          headers: {
              "Content-Type": "application/x-www-form-urlencoded"
          },
          method: "post",
        }).then(function(response) {
          if(response.ok) {
            return response.json()
          } else {
            return {'error': response.status }
          }
        }).then(function(json) {
          vm.response = json;
          if(json.refresh_token) {
            setInterval(vm.refresh, (json.expires_in * 1000));
          }
          vm.stage = 1;
        }).catch(function() {
          vm.response = {'error': 'unable to fetch'}
        });
      },
      refresh: function() {
        fetch("https://www.bungie.net/platform/app/oauth/token/", {
          body: "grant_type=refresh_token&refresh_token=" + this.response.refresh_token + "&client_secret=" + localStorage.getItem('secret') + "&client_id=" + localStorage.getItem('id'),
          headers: {
              "Content-Type": "application/x-www-form-urlencoded"
          },
          method: "post",
        }).then(function(response) {
          if(response.ok) {
            return response.json()
          } else {
            return {'error': response.status }
          }
        }).then(function(json) {
          vm.response = json;
        }).catch(function() {
          vm.response = {'error': 'unable to fetch'}
        });
      },
      getMembershipData: function() {
        fetch("https://www.bungie.net/platform/User/GetMembershipsForCurrentUser/", {
          headers: {
              "X-API-Key": localStorage.getItem('key'),
              "Authorization": this.response.token_type + " " + this.response.access_token
          },
          method: "get",
        }).then(function(response) {
          if(response.ok) {
            return response.json()
          } else {
            return {'error': response.status }
          }
        }).then(function(json) {
          vm.user = json.Response;
          vm.stage = 2;
        }).catch(function() {
          vm.user = {'error': 'unable to fetch'}
        });
      },
      accountTypeToPlaintext: function(accountType) {
        var converter = {
          "1": "Xbox",
          "2": "PSN",
          "4": "Blizzard"
        }
        return converter[accountType]
      },
      getProfile: function(membershipType, destinyMembershipId) {
        var res;
        var components = [
          100,
          102,
          103,
          200,
          201,
          202,
          205,
          300,
          302,
          304,
          305,
          306,
          307,
          308
        ]
        fetch("https://www.bungie.net/platform/Destiny2/" + membershipType + "/Profile/" + destinyMembershipId + "/?components=" + components.join(), {
          headers: {
              "X-API-Key": localStorage.getItem('key'),
              "Authorization": this.response.token_type + " " + this.response.access_token
          },
          method: "get",
        }).then(function(response) {
          if(response.ok) {
            return response.json()
          } else {
            return {'error': response.status }
          }
        }).then(function(json) {
          vm.profiles[membershipType] = json.Response;
        }).catch(function() {
          vm.profiles[membershipType] = {'error': 'unable to fetch'}
        });
      },
      getManifest: function() {
        fetch("https://www.bungie.net/platform/Destiny2/Manifest/", {
          headers: {
              "X-API-Key": localStorage.getItem('key')
          },
          method: "get",
        }).then(function(response) {
          if(response.ok) {
            return response.json()
          } else {
            return {'error': response.status }
          }
        }).then(function(json) {
          localStorage.setItem('manifest', JSON.stringify(json));
          vm.manifest = json;
        }).catch(function() {
          vm.manifest = {'error': 'unable to fetch'}
        });
      }
    },
    data: {
      stage: 0,
      response: {'error': "check the console for details"},
      user: {},
      profile: {},
      profiles: {
        "1": {},
        "2": {},
        "4": {},
      },
      manifest: undefined,
    },
    created: function() {
      this.load();
    }
  })
</script>
